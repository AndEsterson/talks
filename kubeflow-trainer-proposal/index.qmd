---
author: "Andrew Esterson"
date: 2025-10-19
format: revealjs
subtitle: ""
title: "Kubeflow Trainer Workflow"
---

## Kubeflow Trainer out of the box

```{mermaid}
flowchart LR
  A(user submits a job .) --> B(TrainJob created .)
  B --> C(Pods are 
          created .)
  C --> D(Pods run to 
          completion/failure ..)
  D --> E(Trainjob is updated .. 
          to reflect
          completion/failure ..)
```

## Some problems

- What if the pods need to queue for resources? We have no gang scheduling, no shared resource pools, and no fairness scheduling 
- How does the user see the logs for the job? Currently they must manually watch the pod logs in real time
- What happens to stale Trainjobs? Currently they stay there forever, steadily increaasing the size of the etcd database

## Updated Kubeflow Trainer

```{mermaid}
%%| fig-width: 100
%%| fig-height: 100
%%{init: {
"flowchart": {
  "rankSpacing": 40
}
}}%%
flowchart LR
  classDef withmargines fill-opacity:0.0,color:#FFFFFF,stroke-width:0px;
  A(User submits a job .) --> B(TrainJob created .)
  C --> D(Pods run to 
          completion/failure .)
  D --> E(Trainjob is updated ..
          to reflect 
          completion/failure ..)
  B --> Z
  Z2 --> C(Pods are created .)
  Z3 --> C
  D --> X
  E --> Y(Delete jobs which 
          have been finished .
          for over 1 week)

  subgraph volcano [Volcano
                    Scheduler .]
    direction LR
    Z(Volcano PodGroup ..
      created)
    Z1(Check enough resources ..
      available to schedule
      the TrainJob)
    Z2(Borrow resources
      from other pools
      if required and allowed ..)
    Z3(Reclaim resources
      from other pools
      if required and possible ..)
    
    Z --> Z1
    Z1 --> Z2
    Z1 --> Z3
  end

  subgraph loki [Loki 
                Log persistence .]
    foo1["<p style='width:100px;height:0px;margin:0'>Invisible !!!/p>"]:::withmargines
    foo2["<p style='width:100px;height:0px;margin:0'>Invisible !!!/p>"]:::withmargines
    X1(Logs are forwarded ..
      from Alloy to
      the Loki database)
    X2(Grafana queries Loki
      for admin dashboards ..)
    X3(User facing 
      web-app queries Loki ..)
    X4(User directly .
      queries Loki)
    X(Pod logs are collected ..
      by Grafana Alloy)
    X2 --> X1
    X3 ---> X1
    X4 ---> X1
    X --> X1
  end


  subgraph kyverno [Kyverno
                    cleanup .]
    Y
  end
```
